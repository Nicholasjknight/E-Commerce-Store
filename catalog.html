<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog</title>

    <!-- Styles and Favicon -->
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="/images/Man Kave Text.png" type="image/x-icon">

    <!-- Load Environment Variables First -->
    <script src="/env.js"></script>

    <!-- Firebase SDK (Fixes "firebase is not defined" issue) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    
    <!-- Snipcart Styles -->
    <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.css" />

    <!-- Snipcart API Key Configuration (Fixes "Invalid API Key" error) -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const snipcartDiv = document.getElementById("snipcart");
            if (!snipcartDiv.hasAttribute("data-api-key")) {
                snipcartDiv.setAttribute("data-api-key", window.env?.SNIPCART_API_KEY || "YOUR_DEFAULT_API_KEY_HERE");
            }
        });
    </script>

    <!-- Load Snipcart AFTER Setting API Key -->
    <script async src="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.js"></script>

    <!-- Essential Scripts -->
    <script defer src="/script.js"></script>
    <script defer src="/account.js"></script>
</head>

<body>
    <!-- Snipcart API Key Configuration -->
    <div hidden id="snipcart" data-api-key="Njg5ZjVkMjAtNzk5Ny00ZjRhLTg2YTctOGZlY2NjNzA4ZDNkNjM4NjU5OTY3MDg3MTg0MzA2"></div>

    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <main>
        <h1>Product Catalog</h1>
        <div id="filter-container" class="filter-container">
            <select id="filterOptions" class="filter-select">
                <option value="default">Sort By</option>
                <option value="az">A-Z</option>
                <option value="lowPrice">Lowest Price</option>
                <option value="highPrice">Highest Price</option>
            </select>
        </div>
        <div id="catalog-container" class="catalog-grid"></div>
    </main>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Merged Initialization Logic -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("Catalog page scripts initializing...");

            // Ensure Snipcart is Ready Before Updating Cart UI
            const checkSnipcartReady = setInterval(() => {
                if (window.Snipcart && window.Snipcart.store) {
                    console.log("Snipcart is ready!");
                    if (typeof initializeCartUI === "function") {
                        initializeCartUI();
                    }
                    clearInterval(checkSnipcartReady);
                }
            }, 500);

            document.addEventListener("snipcart.ready", () => {
                console.log("Snipcart is fully initialized.");
                if (typeof initializeCartUI === "function") {
                    initializeCartUI();
                }
            });

            // Load Products & Sorting
            try {
                const { loadProducts, renderProducts } = await import('/render_products.js');
                const products = await loadProducts();

                const renderAllProducts = () => {
                    renderProducts(products, 'catalog-container');
                };

                // Add filter functionality
                const filterSelect = document.getElementById('filterOptions');
                filterSelect.addEventListener('change', () => {
                    const sortOption = filterSelect.value;
                    let sortedProducts = [...products];

                    if (sortOption === 'az') {
                        sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
                    } else if (sortOption === 'lowPrice') {
                        sortedProducts.sort((a, b) => a.offers[0].price - b.offers[0].price);
                    } else if (sortOption === 'highPrice') {
                        sortedProducts.sort((a, b) => b.offers[0].price - a.offers[0].price);
                    }

                    renderProducts(sortedProducts, 'catalog-container');
                });

                renderAllProducts();
            } catch (error) {
                console.error("Error loading product data:", error);
            }

            // Load Header and Footer
            fetch('/header.html')
                .then(response => response.text())
                .then(data => document.getElementById('header-placeholder').innerHTML = data)
                .then(() => {
                    console.log("Header loaded. Checking login state...");
                    updateSignInLink();  // Ensure the Sign In / Sign Out button updates correctly
                })
                .catch(error => console.error('Error loading header:', error));

            fetch('/footer.html')
                .then(response => response.text())
                .then(data => document.getElementById('footer-placeholder').innerHTML = data)
                .catch(error => console.error('Error loading footer:', error));
        });

        // Ensure Sign In / Sign Out updates properly
        function updateSignInLink() {
            console.log("Checking user login status...");
            const signInLink = document.getElementById("signInLink");
            if (!signInLink) {
                console.warn("Sign In link not found in header.");
                return;
            }

            const user = firebase.auth().currentUser;
            if (user) {
                signInLink.innerHTML = `<a href="#" onclick="signOut()">Sign Out</a>`;
                console.log(`User signed in: ${user.email}`);
            } else {
                signInLink.innerHTML = `<a href="#" onclick="openModal('loginModal')">Sign In</a>`;
                console.log("User is not signed in.");
            }
        }

        function signOut() {
            firebase.auth().signOut().then(() => {
                console.log("User signed out.");
                updateSignInLink();
            }).catch(error => {
                console.error("Error signing out:", error);
            });
        }
    </script>

    <!-- Additional Scripts -->
    <script type="module" src="/JSON-LD_breadcrumbs.js"></script>
    <script src="/search.js"></script>

</body>
</html>
