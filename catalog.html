<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="/images/Man Kave Text.png" type="image/x-icon">
    <script src="/env.js"></script>
    <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.css" />
    <script async src="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.js"></script>
    <!-- Add Script.js for Initial Load -->
    <script defer src="/script.js"></script>
</head>

<body>
    <div hidden id="snipcart" data-api-key=""></div>

    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <main>
        <h1>Product Catalog</h1>
        <div id="filter-container" class="filter-container">
            <select id="filterOptions" class="filter-select">
                <option value="default">Sort By</option>
                <option value="az">A-Z</option>
                <option value="lowPrice">Lowest Price</option>
                <option value="highPrice">Highest Price</option>
            </select>
        </div>
        <div id="catalog-container" class="catalog-grid"></div>
    </main>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Load Environment Variables -->
    <script src="/env.js"></script>

    <!-- Snipcart Initialization -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("Catalog: DOM fully loaded.");
    
            // Snipcart API Key Initialization
            const snipcartDiv = document.getElementById("snipcart");
            const apiKey = window.env?.SNIPCART_API_KEY || "YOUR_FALLBACK_API_KEY";
    
            if (!apiKey) {
                console.error("Snipcart API key missing. Check env.js.");
                return;
            }
            snipcartDiv.setAttribute("data-api-key", apiKey);
    
            // Retry Snipcart Initialization
            const initializeSnipcart = (retryCount = 0, maxRetries = 15) => {
                if (window.Snipcart && window.Snipcart.store) {
                    console.log("Snipcart initialized successfully.");
                    initializeCartUI(); // Call cart UI setup
                    return;
                }
    
                if (retryCount >= maxRetries) {
                    console.error("Failed to initialize Snipcart after maximum retries.");
                    return;
                }
    
                console.warn(`Snipcart not ready. Retrying... (${retryCount + 1}/${maxRetries})`);
                setTimeout(() => initializeSnipcart(retryCount + 1, maxRetries), 1000);
            };
    
            initializeSnipcart();
    
            // Product Loading
            try {
                console.log("Loading products...");
                const { loadProducts, renderProducts } = await import('./render_products.js');
                const products = await loadProducts();
    
                // Render Products
                renderProducts(products, 'catalog-container');
    
                // Add Sorting Functionality
                const filterSelect = document.getElementById("filterOptions");
                filterSelect.addEventListener("change", () => {
                    const sortOption = filterSelect.value;
                    let sortedProducts = [...products];
    
                    if (sortOption === 'az') {
                        sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
                    } else if (sortOption === 'lowPrice') {
                        sortedProducts.sort((a, b) => a.offers[0].price - b.offers[0].price);
                    } else if (sortOption === 'highPrice') {
                        sortedProducts.sort((a, b) => b.offers[0].price - a.offers[0].price);
                    }
    
                    renderProducts(sortedProducts, 'catalog-container');
                });
    
            } catch (error) {
                console.error("Error loading products:", error);
            }
    
            // Dynamic Header and Footer Loading
            try {
                const header = await fetch('/header.html').then((res) => res.text());
                document.getElementById('header-placeholder').innerHTML = header;
    
                const footer = await fetch('/footer.html').then((res) => res.text());
                document.getElementById('footer-placeholder').innerHTML = footer;
            } catch (error) {
                console.error("Error loading header or footer:", error);
            }
        });
    </script>
    

    <!-- Account and Additional Scripts -->
    <script defer src="/account.js"></script>
    <script src="/search.js"></script>

</body>

</html>
