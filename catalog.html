<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="/images/Man Kave Text.png" type="image/x-icon">
    <script src="/env.js"></script>
    <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.css" />
    <script async src="https://cdn.snipcart.com/themes/v3.0.31/default/snipcart.js"></script>
    <!-- Add Script.js for Initial Load -->
    <script defer src="/script.js"></script>
</head>

<body>
    <div hidden id="snipcart" data-api-key=""></div>

    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <main>
        <h1>Product Catalog</h1>
        <div id="filter-container" class="filter-container">
            <select id="filterOptions" class="filter-select">
                <option value="default">Sort By</option>
                <option value="az">A-Z</option>
                <option value="lowPrice">Lowest Price</option>
                <option value="highPrice">Highest Price</option>
            </select>
        </div>
        <div id="catalog-container" class="catalog-grid"></div>
    </main>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Load Environment Variables -->
    <script src="/env.js"></script>

    <!-- Snipcart Initialization -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("DOM fully loaded and parsed for Catalog.");
    
            const snipcartDiv = document.getElementById("snipcart");
            const apiKey = window.env?.SNIPCART_API_KEY || "YOUR_FALLBACK_API_KEY";
    
            if (!apiKey) {
                console.error("Snipcart API key is missing. Check env.js or fallback key.");
                return;
            }
            snipcartDiv.setAttribute("data-api-key", apiKey);
    
            const initializeSnipcartForCatalog = (retryCount = 0, maxRetries = 15) => {
                if (window.Snipcart && window.Snipcart.store) {
                    console.log("Snipcart initialized successfully for Catalog!");
                    initializeCartUIForCatalog(); // Use the renamed function for this page
                    return;
                }
    
                if (retryCount >= maxRetries) {
                    console.error("Failed to initialize Snipcart after maximum retries.");
                    return;
                }
    
                console.warn(`Snipcart not ready. Retrying... (${retryCount + 1}/${maxRetries})`);
                setTimeout(() => initializeSnipcartForCatalog(retryCount + 1, maxRetries), 1000);
            };
    
            initializeSnipcartForCatalog();
    
            // Load and render products
            const { loadProducts, renderProducts } = await import('/render_products.js');
            const products = await loadProducts();
    
            const renderAllProducts = () => {
                renderProducts(products, 'catalog-container');
            };
    
            // Add sorting functionality
            const filterSelect = document.getElementById("filterOptions");
            filterSelect.addEventListener("change", () => {
                const sortOption = filterSelect.value;
                let sortedProducts = [...products];
    
                if (sortOption === 'az') {
                    sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
                } else if (sortOption === 'lowPrice') {
                    sortedProducts.sort((a, b) => a.offers[0].price - b.offers[0].price);
                } else if (sortOption === 'highPrice') {
                    sortedProducts.sort((a, b) => b.offers[0].price - a.offers[0].price);
                }
    
                renderProducts(sortedProducts, 'catalog-container');
            });
    
            renderAllProducts();
    
            // Load header and footer dynamically
            fetch('/header.html')
                .then(response => response.text())
                .then(data => document.getElementById('header-placeholder').innerHTML = data)
                .catch(error => console.error('Error loading header:', error));
    
            fetch('/footer.html')
                .then(response => response.text())
                .then(data => document.getElementById('footer-placeholder').innerHTML = data)
                .catch(error => console.error('Error loading footer:', error));
        });
    
        // Renamed Function for Cart UI
        function initializeCartUIForCatalog() {
            const cartIcon = document.getElementById("cartIcon");
            const cartCountElement = document.getElementById("cartCount");
    
            function updateCartUI() {
                const cartState = Snipcart?.store?.getState()?.cart || {};
                const itemCount = cartState.items?.count || 0;
    
                if (cartCountElement) cartCountElement.textContent = itemCount;
                if (cartIcon) {
                    cartIcon.src = itemCount > 0 ? "/images/fullcart.png" : "/images/emptycart.png";
                    cartIcon.alt = itemCount > 0 ? "Full Cart" : "Empty Cart";
                }
            }
    
            if (typeof Snipcart !== "undefined" && Snipcart.store) {
                Snipcart.store.subscribe(updateCartUI);
                updateCartUI();
            } else {
                console.warn("Snipcart is not ready. Retrying initialization...");
                setTimeout(initializeCartUIForCatalog, 1000); // Retry after 1 second
            }
        }
    </script>
    

    <!-- Account and Additional Scripts -->
    <script defer src="/account.js"></script>
    <script src="/search.js"></script>

</body>

</html>
